name: CICD

on:
  push:
    tags:
      - 'v*'

env:
  ARTIFACT_DIR: release-artifacts

jobs:
  # check:
  #   runs-on: ubuntu-latest
  #   services:
  #     redis:
  #       image: redis
  #       ports:
  #         - 6379:6379
  #       options: --entrypoint redis-server
  #   steps:
  #     - name: Check out the repo
  #       uses: actions/checkout@v3

  #     - name: Init rust envrionment
  #       uses: actions-rs/toolchain@v1
  #       with:
  #         toolchain: stable
  #         components: rustfmt, clippy

  #     - name: Cache rust
  #       uses: Swatinem/rust-cache@v2

  #     - name: Check format
  #       run: cargo fmt --all -- --check

  #     - name: Check clippy
  #       run: cargo clippy --all --all-features

  #     - name: Run test
  #       run: cargo test --all-features

  #     - name: Upload to codecov.io
  #       uses: codecov/codecov-action@v2
  #       with:
  #         token: ${{secrets.CODECOV_TOKEN}}

  #     - name: Archive code coverage results
  #       uses: actions/upload-artifact@v2
  #       with:
  #         name: code-coverage-report
  #         path: cobertura.xml

  release-linux:
#    if: startsWith(github.ref, 'refs/tags/')
#    needs: [check]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          [
            aarch64-unknown-linux-gnu,
            x86_64-unknown-linux-gnu,
          ]
    steps:
      - name: Check out the repo
        uses: actions/checkout@v3

      - name: Init rust envrionment
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true
          target: ${{ matrix.target }}

      - name: Run build
        uses: actions-rs/cargo@v1
        with:
          use-cross: true
          command: build
          args: --release --target ${{ matrix.target }}

      - name: Prepare artifacts
        run: |
          SRC_DIR=target/${{ matrix.target }}/release
          DEST_DIR=${{ env.ARTIFACT_DIR }}
          mkdir -p ${DEST_DIR}

          RELEASE_NAME=action-test-${{ matrix.target }}-${{ github.ref_name }}
          CHECKSUM=${RELEASE_NAME}.checksum.txt
          mv ${SRC_DIR}/action-test ${RELEASE_NAME}
          shasum -a 256 ${SRC_DIR}/${RELEASE_NAME} > ${CHECKSUM}

          cp ${RELEASE_NAME} ${DEST_DIR}
          cp ${CHECKSUM} ${DEST_DIR}

          ls ${DEST_DIR}

      - name: Upload artifacts to summary
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.ARTIFACT_DIR }}
          path: |
            *.*

      - name: Upload artifacts to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.*
